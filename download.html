<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Download - Filmixo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #f0f2f5;
            color: #1c1e21;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        .download-container {
            max-width: 600px;
            width: 100%;
            margin-top: 50px;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-align: center;
        }
        .icon-success {
            color: #1da1f2; /* এখন এটি একটি স্টেপ */
            font-size: 60px;
            margin-bottom: 20px;
        }
        .download-title {
            font-size: 24px;
            font-weight: 800;
            color: #0f1419;
            margin-bottom: 10px;
        }
        .download-meta {
            font-size: 15px;
            color: #536471;
            margin-bottom: 30px;
        }
        /* বাটন স্টাইল */
        .download-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 15px 20px;
            margin-top: 20px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
            text-transform: uppercase;
            color: white;
        }
        .download-btn i {
            margin-right: 10px;
        }
        /* প্রথম ক্লিকে অ্যাড বাটন (নীল) */
        .btn-ad-click {
             background: #1da1f2; 
        }
        .btn-ad-click:hover {
            background: #0d8bd9;
        }
        /* দ্বিতীয় ক্লিকে কন্টিনিউ বাটন (সবুজ) */
        .btn-continue {
            background: #28a745; 
        }
        .btn-continue:hover {
            background: #218838;
        }
        .loading-message {
            font-size: 16px;
            color: #1da1f2;
            margin-top: 20px;
        }
        .error-message {
            font-size: 16px;
            color: #dc3545;
            margin-top: 20px;
        }
    </style>
</head>
<body>

<div class="download-container">
    <i class="fa-solid fa-cloud-arrow-down icon-success"></i>
    <h1 class="download-title" id="downloadTitle">Preparing Download Link...</h1>
    <p class="download-meta" id="downloadMeta">We need a quick verification step before the final download.</p>
    
    <div id="loadingStatus" class="loading-message">
        <i class="fa-solid fa-spinner fa-spin"></i> Loading Post Data...
    </div>

    <button class="download-btn btn-ad-click" id="finalDownloadButton" style="display:none;">
        <i class="fa-solid fa-arrow-up-right-from-square"></i> Visit Ad to Unlock Download
    </button>

    <p id="errorBox" class="error-message" style="display:none;"></p>
</div>

<script>
    // --- কনফিগারেশন ---
    const AD_LINKS = [
        'https://prototypesorting.com/p99vwjq2?key=57217116cccb25526dfb6a5a4edd9aea', 
        // আপনি এখানে আপনার প্রয়োজনমতো অন্যান্য অ্যাড লিংক যোগ করতে পারেন
    ];
    // এই পেজের জন্য পৃথক সেশন স্টোরেজ কী (অন্য পেজের সাথে মিশে না যাওয়ার জন্য)
    const SESSION_KEY = 'filmixo_download_ad_status'; 
    const AD_INDEX_KEY = 'filmixo_download_ad_index';
    
    let currentAdIndex = parseInt(localStorage.getItem(AD_INDEX_KEY)) || 0;
    let postId = null;
    let finalDownloadLink = null;

    // --- কোর লজিক: অ্যাড এবং ডাউনলোড হ্যান্ডলিং ---
    
    // বাটন ক্লিক হ্যান্ডলার
    function handleDownloadClick() {
        if (!finalDownloadLink || !postId) {
            console.error("Download link not available.");
            return;
        }

        const btn = document.getElementById('finalDownloadButton');
        let status = sessionStorage.getItem(SESSION_KEY);
        
        if (status !== 'clicked') {
            // --- প্রথম ক্লিক: অ্যাড ভিজিট ---
            
            // অ্যাড রোটেশন লজিক
            const adLink = AD_LINKS[currentAdIndex % AD_LINKS.length];
            currentAdIndex = (currentAdIndex + 1) % AD_LINKS.length; 
            localStorage.setItem(AD_INDEX_KEY, currentAdIndex);
            
            // সেশন স্ট্যাটাস আপডেট: ক্লিক হয়েছে
            sessionStorage.setItem(SESSION_KEY, 'clicked');
            
            // UI আপডেট: বাটনের লেখা পরিবর্তন
            updateButtonState('continue');
            
            // বর্তমান ট্যাবেই অ্যাড লিঙ্কে রিডাইরেক্ট
            window.location.href = adLink; 

        } else {
            // --- দ্বিতীয় ক্লিক: চূড়ান্ত ডাউনলোডে রিডাইরেক্ট ---
            
            // সেশন স্টোরেজ থেকে স্ট্যাটাস মুছে দেওয়া
            sessionStorage.removeItem(SESSION_KEY); 

            // চূড়ান্ত ডাউনলোড লিংকে রিডাইরেক্ট
            window.location.href = finalDownloadLink;
        }
    }
    
    // বাটনের অবস্থা পরিবর্তনকারী ফাংশন
    function updateButtonState(state) {
        const btn = document.getElementById('finalDownloadButton');
        if (state === 'continue') {
            btn.innerHTML = `<i class="fa-solid fa-download"></i> Continue to Final Download`;
            btn.classList.remove('btn-ad-click');
            btn.classList.add('btn-continue');
        } else { // state === 'initial'
             btn.innerHTML = `<i class="fa-solid fa-arrow-up-right-from-square"></i> Visit Ad to Unlock Download`;
             btn.classList.remove('btn-continue');
             btn.classList.add('btn-ad-click');
        }
    }

    // পেজ লোডের সময় বাটনের প্রাথমিক অবস্থা চেক করা
    function checkInitialState() {
        const status = sessionStorage.getItem(SESSION_KEY);
        if (status === 'clicked') {
            // যদি একবার ক্লিক করা হয়ে থাকে (অ্যাড ভিজিট হয়ে গেছে)
            updateButtonState('continue');
        } else {
            updateButtonState('initial');
        }
    }


    // --- কোর লজিক: JSON থেকে ডেটা লোড করা ---
    
    async function loadPostDataAndSetup() {
        const urlParams = new URLSearchParams(window.location.search);
        postId = urlParams.get('id');
        const loadingStatus = document.getElementById('loadingStatus');
        const errorBox = document.getElementById('errorBox');
        const downloadButton = document.getElementById('finalDownloadButton');
        
        if (!postId) {
            document.getElementById('downloadTitle').innerText = "Error: Post ID Missing";
            loadingStatus.style.display = 'none';
            errorBox.innerText = "The required Post ID is missing.";
            errorBox.style.display = 'block';
            return;
        }
        
        try {
            const res = await fetch('posts.json');
            if (!res.ok) throw new Error(`Failed to load posts data (HTTP Status: ${res.status})`);
            
            const posts = await res.json();
            const post = posts.find(p => p.id === postId);

            if (post && post.downloadLink) {
                // ১. গ্লোবাল ভেরিয়েবলে ডাউনলোড লিংক সংরক্ষণ
                finalDownloadLink = post.downloadLink;
                
                // ২. UI আপডেট
                document.getElementById('pageTitle').innerText = `Download: ${post.title}`;
                document.getElementById('downloadTitle').innerText = `Download: ${post.title}`;
                document.getElementById('downloadMeta').innerText = `Movie: ${post.title} | Duration: ${post.videoDuration}`;
                
                // ৩. UI দেখাও এবং ইভেন্ট লিসেনার সেট করো
                loadingStatus.style.display = 'none';
                downloadButton.style.display = 'flex';
                downloadButton.addEventListener('click', handleDownloadClick);
                
                // ৪. পেজ লোডের সময় বাটনের অবস্থা সেট করো
                checkInitialState();
                
            } else {
                document.getElementById('downloadTitle').innerText = "Download Link Not Found";
                loadingStatus.style.display = 'none';
                errorBox.innerText = `Could not find a valid download link for Post ID: ${postId}. Please check posts.json.`;
                errorBox.style.display = 'block';
            }

        } catch (error) {
            console.error("Download Setup Error:", error);
            document.getElementById('downloadTitle').innerText = "Content Load Error";
            loadingStatus.style.display = 'none';
            errorBox.innerText = `Error: ${error.message}`;
            errorBox.style.display = 'block';
        }
    }

    // ব্রাউজার ব্যাক বাটন চাপলে বা ক্যাশ থেকে লোড হলে (যাতে স্পিনার চলে না)
    window.addEventListener('pageshow', () => {
        loadPostDataAndSetup(); 
    });

    // প্রথমবার পেজ লোড করা
    loadPostDataAndSetup(); 
</script>

</body>
</html>
