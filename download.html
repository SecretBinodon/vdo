<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Download - Secret Binodon</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* আপনার প্রয়োজনীয় স্টাইল এখানে থাকবে */
        body { 
            font-family: Arial, sans-serif; 
            background: #f4f4f4; 
            color: #333; 
            padding: 20px; 
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .download-container { 
            max-width: 600px; 
            width: 100%; 
            background: white; 
            padding: 30px; 
            border-radius: 8px; 
            box-shadow: 0 0 10px rgba(0,0,0,0.1); 
            text-align: center;
        }
        .download-title { 
            color: #1da1f2; 
            margin-bottom: 20px; 
            font-size: 24px;
        }
        .download-meta { 
            font-size: 14px; 
            color: #777; 
            margin-bottom: 30px; 
        }
        /* একক ডাউনলোড বাটন */
        .download-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 15px;
            margin-top: 20px;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }
        .download-btn:hover { opacity: 0.9; }
        .download-btn i { margin-right: 10px; }
        
        /* বাটনের অবস্থার জন্য রঙ */
        .btn-ad-click { background: #1da1f2; } /* অ্যাড ভিজিটের জন্য */
        .btn-continue { background: #28a745; } /* কন্টিনিউ/ডাউনলোডের জন্য */
        .btn-loading { background: #ffc107; } /* লোডিং/অন্যান্য */
        .btn-continue:hover { background: #218838; }
        .btn-ad-click:hover { background: #0d8bd9; }
    </style>
</head>
<body>

<div class="download-container">
    <h1 class="download-title" id="downloadTitle">Loading Download Data...</h1>
    <div class="download-meta" id="downloadMeta"></div>
    
    <button class="download-btn btn-ad-click" id="finalDownloadButton" style="display:none;">
        <i class="fa-solid fa-cloud-arrow-down"></i> Prepare Download
    </button>
</div>

<script>
    // --- কনফিগারেশন এবং গ্লোবাল স্টেট ---
    const AD_LINKS = [
        "https://adlink1.com/click",
        "https://adlink2.com/click",
        "https://adlink3.com/click",
        // এখানে আপনার সব অ্যাড লিংক যুক্ত করুন
    ];
    // localStorage ব্যবহার করে অ্যাড রোটেশন ইনডেক্স সেভ করা
    const AD_INDEX_KEY = 'sb_ad_rotation_index_dl'; // DL যোগ করা হলো যাতে post.html এর সাথে কনফ্লিক্ট না হয়
    // sessionStorage ব্যবহার করে এই পোস্টের জন্য অ্যাড ক্লিক হয়েছে কিনা, তা সেভ করা
    const POST_STATUS_KEY = 'sb_download_ad_status_dl'; 

    let postId = null;
    let finalDownloadLink = null;
    let currentAdIndex = parseInt(localStorage.getItem(AD_INDEX_KEY)) || 0;
    
    // --- ইউটিলিটি ফাংশন ---
    
    // বাটনের অবস্থা আপডেট করা
    function updateButton(isClicked) {
        const btn = document.getElementById('finalDownloadButton');
        if (isClicked) {
            // ২য় ক্লিক স্ট্যাটাস: কন্টিনিউ মোড
            btn.innerHTML = `<i class="fa-solid fa-arrow-right"></i> Continue to Final Download`;
            btn.classList.remove('btn-ad-click');
            btn.classList.add('btn-continue');
        } else {
            // ১ম ক্লিক স্ট্যাটাস: অ্যাড ভিজিট মোড
            btn.innerHTML = `<i class="fa-solid fa-arrow-up-right-from-square"></i> Visit Ad to Unlock Download`;
            btn.classList.remove('btn-continue');
            btn.classList.add('btn-ad-click');
        }
    }

    // --- কোর লজিক: অ্যাড এবং ডাউনলোড হ্যান্ডলিং ---
    
    function handleDownloadClick() {
        if (!finalDownloadLink || !postId) return;

        // এই পোস্টের জন্য স্ট্যাটাস লোড করা
        let status = JSON.parse(sessionStorage.getItem(POST_STATUS_KEY)) || {};
        let isAdClicked = status[postId] === true;
        
        if (!isAdClicked) {
            // --- প্রথম ক্লিক: অ্যাড ভিজিট ---
            
            // ১. অ্যাড লিংক নির্বাচন ও ভিজিট
            const adLink = AD_LINKS[currentAdIndex % AD_LINKS.length];
            window.open(adLink, '_blank');
            
            // ২. অ্যাড রোটেশন ইনডেক্স আপডেট
            currentAdIndex = (currentAdIndex + 1) % AD_LINKS.length; 
            localStorage.setItem(AD_INDEX_KEY, currentAdIndex);
            
            // ৩. সেশন স্ট্যাটাস আপডেট: ক্লিক হয়েছে
            status[postId] = true;
            sessionStorage.setItem(POST_STATUS_KEY, JSON.stringify(status));
            
            // ৪. UI আপডেট: কন্টিনিউ মোডে সেট করা
            updateButton(true);
            
        } else {
            // --- দ্বিতীয় ক্লিক: চূড়ান্ত ডাউনলোডে রিডাইরেক্ট ---
            
            // ১. সেশন স্ট্যাটাস রিসেট
            delete status[postId];
            sessionStorage.setItem(POST_STATUS_KEY, JSON.stringify(status));

            // ২. চূড়ান্ত ডাউনলোড লিংকে রিডাইরেক্ট
            window.location.href = finalDownloadLink;
        }
    }
    
    // --- পেজ লোড এবং ডেটা লোড ---
    
    async function loadPostData() {
        try {
            const urlParams = new URLSearchParams(window.location.search);
            postId = urlParams.get('id');
            const downloadButton = document.getElementById('finalDownloadButton');

            if (!postId) {
                document.getElementById('downloadTitle').innerText = "Error: Post ID Missing";
                document.getElementById('downloadMeta').innerText = "The post ID required for download is missing.";
                return;
            }

            const res = await fetch('posts.json');
            if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
            const posts = await res.json();
            const post = posts.find(p => p.id === postId);

            if (post && post.downloadLink) {
                // ১. ডাউনলোড লিংক সংরক্ষণ
                finalDownloadLink = post.downloadLink;
                
                // ২. UI আপডেট
                document.getElementById('pageTitle').innerText = `Download: ${post.title}`;
                document.getElementById('downloadTitle').innerText = `Download: ${post.title}`;
                document.getElementById('downloadMeta').innerText = `Your download link is ready for ${post.videoDuration || 'N/A'} content.`;
                
                // ৩. বাটন দেখানো এবং ইভেন্ট লিসেনার সেট করা
                downloadButton.style.display = 'flex';
                downloadButton.addEventListener('click', handleDownloadClick);
                
                // ৪. প্রাথমিক অবস্থা সেট করা
                checkInitialState();


            } else {
                document.getElementById('downloadTitle').innerText = "Download Link Not Found";
                document.getElementById('downloadMeta').innerText = `Could not find a valid download link for Post ID: ${postId}.`;
            }

        } catch (error) {
            console.error("Error loading post data:", error);
            document.getElementById('downloadTitle').innerText = "Content Load Error";
            document.getElementById('downloadMeta').innerText = `Failed to load data.`;
        }
    }

    // পেজ লোড বা রিফ্রেশ হলে বাটনের অবস্থা চেক করা
    function checkInitialState() {
        if (!postId) return;
        let status = JSON.parse(sessionStorage.getItem(POST_STATUS_KEY)) || {};
        let isAdClicked = status[postId] === true;
        
        // অ্যাড ক্লিক হয়ে থাকলে কন্টিনিউ মোডে সেট করা
        updateButton(isAdClicked);
    }
    
    // DOM লোড হওয়ার পর শুরু করা
    document.addEventListener('DOMContentLoaded', () => {
        loadPostData();
    });

    // ব্রাউজার ব্যাক বাটন প্রেস করার পর BFCache থেকে লোড হলে
    window.addEventListener('pageshow', (event) => {
        if (event.persisted) {
             checkInitialState();
        }
    });
    
</script>

</body>
</html>
